<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content="脑洞很大，可能会写很多东西也可能不会"><meta name="keyword"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Dva+React服务端渲染(SSR)实践记录</title><link rel="shortcut icon" href="/images/avatar.png" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"></head><body><header class="container" id="header"><div class="header"><div class="header-left"><div class="avatar"><img src="/images/avatar.png"></div><div class="author"><div class="author-name"><a href="/">橡树的空想盒子</a></div><div class="about-me">Basta andare così</div></div></div><div class="header-right"><ul class="navigation"><li><a href="/archives">归档</a></li></ul></div><div class="about-me-mask"><div class="about-me-wrap"><div class="about-me__header"><div class="avatar"><img src="/images/avatar.png"></div></div><ul class="socials"><li class="social-item"><span class="label"><img src="/images/socials/github.svg" alt="https://mymipo.github.io/"></span><a href="https://mymipo.github.io/" target="_blank" title="https://mymipo.github.io/">https://mymipo.github.io/</a></li><li class="social-item"><span class="label"><img src="/images/socials/email.svg" alt="suhuangliping@gmail.com"></span><span>suhuangliping@gmail.com</span></li></ul></div></div></div></header><div class="container post"><section class="article"><div class="title">Dva+React服务端渲染(SSR)实践记录</div><div class="date">写于2018年08月14日</div><div class="content"><p>项目使用了dva+roadhog+antd-mobile搭建，因为使用客户端渲染首屏白屏的时间太长，为了提升项目的首屏加载速度提高用户体验，在现在的基础上加入了SSR，实现过程中踩了不少坑，所以记录下，希望给有缘看到这篇文章的小伙伴一点帮助…</p>
<p>###实现原理<br>实现网上挺多关于react同构的文章，基本上就是加上一层node，在node层请求需要服务端数据，生成htmlString渲染到浏览器中。然后载入客户端运行代码，这样首屏就可以走服务端渲染，其他会走客户端路由，实现同构。<strong>在dva中比较特殊的是，服务端渲染需要在服务端实例化一次dva，可以把每一个页面当做是一个dva实例</strong></p>
<p>###踩坑记录</p>
<blockquote>
<p>1.服务端没有<code>window</code>对象<br>服务端没有window/document等客户端对象，需要加以判断防止出错：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typeof window === &apos;undefined&apos;;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>2.服务端和客户端的生命周期的处理<br><strong>React在服务端的生命周期只会走到componentDidMount之前的方法，但是在服务端渲染完以后执行客户端代码匹配到相应路由进入到相应组件后会执行客户端生命周期，所以要在客户端的生命周期如果有数据请求，必须要做处理阻止掉</strong>，可以在服务端渲染的时候添加<code>window.__INITIAL_STATE__</code>赋值给客户端的store；</p>
</blockquote>
<blockquote>
<p>3.服务端import、react等语法报错的解决方法<br>可以在服务启动前添加<code>babel-register</code>兼容；<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">require(&apos;babel-register&apos;)(&#123;</span><br><span class="line">  &quot;presets&quot;: [</span><br><span class="line">    &quot;env&quot;,</span><br><span class="line">    &quot;stage-0&quot;,</span><br><span class="line">    &quot;react&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>4.对于样式的处理<br>解决方案1: 可以在服务端渲染的时候忽略掉css不渲染css，如果项目是使用的css可以加载客户端打包的css渲染，如果是使用的预编译方式的话，可以采用第2种方式；<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function ignore() &#123;</span><br><span class="line">  var extensions = [&apos;.css&apos;, &apos;.less&apos;]; //里面定义不需要加载的文件类型</span><br><span class="line">  for (let i = 0, len = extensions.length; i &lt; len; i++) &#123;</span><br><span class="line">    require.extensions[extensions[i]] = function () &#123;</span><br><span class="line">      return false;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>解决方法2：如果你的项目是使用了预编译方式的话可以使用<a href="https://github.com/css-modules/css-modules-require-hook" target="_blank" rel="noopener">css-modules-require-hook</a>来处理css，可以解决掉报错的问题，但是在这里需要注意的话，如果你的项目是使用了<code>roadhog</code>配置的webpack而且开启了cooModeles，服务端编译的样式名称会和客户端的样式名称对应不上，导致服务端渲染的错乱的问题，网上有人推荐使用<a href="https://github.com/catamphetamine/webpack-isomorphic-tools" target="_blank" rel="noopener">webpack-isomorphic-tool</a>解决方案(个人测试没处理成功),有兴趣可以尝试下；<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">require(&apos;css-modules-require-hook&apos;)(&#123;</span><br><span class="line">  extensions: &apos;.less&apos;,</span><br><span class="line">  camelCase: true,</span><br><span class="line">  rootDir: __dirname,</span><br><span class="line">  processorOpts: &#123; parser: require(&apos;postcss-less&apos;).parse &#125;,</span><br><span class="line">  // generateScopedName: &apos;[local]___[hash:base64:5]&apos;</span><br><span class="line">  generateScopedName: &apos;[local]&apos;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>解决方案3：对应方案2无法对应样式名称的问题，我的处理方式是不使用roadhog，自己配置webpack然后搭配<code>css-modules-require-hook</code>来处理css，达到服务端和客户端css样式名称一致的问题；<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  test: /\.less$/,</span><br><span class="line">  exclude: /node_modules/,</span><br><span class="line">  use: [</span><br><span class="line">    &#123;</span><br><span class="line">      loader: MiniCssExtractPlugin.loader</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      loader: &apos;css-loader&apos;,</span><br><span class="line">      options: &#123;</span><br><span class="line">        modules: true,</span><br><span class="line">        localIdentName: &quot;[name]_[local]__[hash:base64:5]&quot;, // 需要注意名称要一致</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</div><div class="tags"><a class="tag-link" href="/tags/react-dva-ssr-同构/">react dva ssr 同构</a></div></section></div><div class="container"><ul class="nav"></ul></div><div id="backToTop"><div class="back-arrow back-arrow-left"></div><div class="back-arrow back-arrow-right"></div></div><footer class="container"><div class="rights"><span>Powered by </span><a href="http://hexo.io" target="_blank">Hexo</a><span>, Theme </span><a href="https://github.com/gary-Shen/hexo-theme-curry" target="_blank">Curry</a><span>.</span></div></footer><script src="/script/jquery.min.js"></script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script src="/script/index.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-61220413-1', 'auto');
ga('send', 'pageview');</script><script src="/script/jquery.min.js"></script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script src="/script/index.js"></script><script src="/script/post.js"></script></body></html>