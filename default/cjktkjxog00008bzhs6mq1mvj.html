

<!DOCTYPE html>
<html lang="zh-CN" xmlns:v-bind="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta name="X-UA-Compatible" content="IE=edge">
    <meta name="author" content="橡树">

    <title>react-ssr - 橡树的空想盒子</title>
    <meta name="description" content="">

    <meta name="keywords"
          content="">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <meta content="telephone=no" name="format-detection">
    <meta name="renderer" content="webkit">
    <noscript>
        <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400|Montserrat|Anonymous+Pro:400|Material+Icons"/>
    </noscript>
    <link rel="short icon" href="/favicon/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/mprogress.css">
    <link rel="stylesheet" href="/css/open-iconic.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml">
    <script>
        /*!
         loadCSS: load a CSS file asynchronously.
         [c]2014 @scottjehl, Filament Group, Inc.
         Licensed MIT
         */
        function loadCSS( href, before, media ){
            "use strict";
            var ss = window.document.createElement( "link" );
            var ref = before || window.document.getElementsByTagName( "script" )[ 0 ];
            var sheets = window.document.styleSheets;
            ss.rel = "stylesheet";
            ss.href = href;
            ss.media = "only x";
            ref.parentNode.insertBefore( ss, ref );
            function toggleMedia(){
                var defined;
                for( var i = 0; i < sheets.length; i++ ){
                    if( sheets[ i ].href && sheets[ i ].href.indexOf( href ) > -1 ){
                        defined = true;
                    }
                }
                if( defined ){
                    ss.media = media || "all";
                }
                else {
                    setTimeout( toggleMedia );
                }
            }
            toggleMedia();
            return ss;
        }
    </script>
</head>
<body>

<div id="app">
    <nav ref="navBar" class="navbar fixed-top navbar-light">
    <div id="global-loading-indicator" class="progress-line global-loading-indicator"></div>
    <div id="nav_background" class="nav-background"></div>
    <div style="padding-left: 15px;padding-right: 15px" class="container container-narrow nav-content">

        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" data-toggle="adropdown">
            <span class="oi" data-glyph="menu"></span>
        </button>
        <a id="nav_title" class="navbar-brand Montserrat" href="/">
            橡树的空想盒子
        </a>
        <div class="float-right navbar-dark nav-icon-group">
            <div class="dropdown">
                <ul class="dropdown-menu" id="collapsed_nav">
                    <li><a href="/" class="a-block nav-icon">首页</a></li>
                    <li><a href="/archives" class="a-block nav-icon">归档</a></li>
                    
                    
                    
                    <li><a href="/https://github.com/mymipo/mymipo.github.io" target="_blank" class="a-block">
                            <span data-glyph="rss" class="oi nav-icon"></span>
                        </a>
                    </li>
                    
                </ul>
            </div>

        </div>
    </div>
</nav>
    <div class="container container-narrow">

        <div ref="pageHead"
             v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"
             class="page-head">
            <a href="/">
                <h2>橡树的空想盒子</h2>
                <h5>Basta andare così</h5>
            </a>
        </div>

<div class="row stream-container">
    <div class="card-container">

        <div class="card card-item clear-border card-top-patch card-clear-hover">
            

            <div class="card-item-container clear-flex-xs">
                <div class="card-inner-cell">
                    <h2>react-ssr</h2>

                    <div>
                        <p>
                            <time datetime="2018-08-14T09:37:40.000Z" itemprop="datePublished">
                                2018-08-14 17:37
                            </time>
                            

                            
                        </p>
                    </div>


                    <p class=" post-block-desc">
                        <hr>
<p>title: Dva+React同构(SSR)实践记录<br>date: 2018-08-14</p>
<h2 id="tags-react-dva-ssr-同构"><a href="#tags-react-dva-ssr-同构" class="headerlink" title="tags: react dva ssr 同构"></a>tags: react dva ssr 同构</h2><p>项目使用了dva+roadhog+antd-mobile搭建，因为使用客户端渲染首屏白屏的时间太长，为了提升项目的首屏加载速度提高用户体验，在现在的基础上加入了SSR，实现过程中踩了不少坑，所以记录下，希望给有缘看到这篇文章的小伙伴一点帮助…</p>
<p>##实现原理<br>实现网上挺多关于react同构的文章，基本上就是加上一层node，用户第一次访问或者刷新当前页面的时候由服务端处理路由，在node层请求所需数据，然后使用<code>React.renderToString</code>生成htmlString渲染到浏览器中，用户点击跳转页面由客户端处理路由，走客户端逻辑，实现同构。<strong>在dva中比较特殊的是，服务端渲染需要在服务端实例化一次dva，可以把每一个页面当做是一个dva实例</strong></p>
<p>##踩坑记录</p>
<blockquote>
<p>1.服务端没有<code>window</code>对象<br>服务端没有window/document等客户端对象，需要加以判断防止出错：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typeof window === &apos;undefined&apos;;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>2.服务端和客户端的生命周期的处理<br><strong>React在服务端的生命周期只会走到componentDidMount之前的方法，但是在服务端渲染完以后执行客户端代码匹配到相应路由进入到相应组件后浏览器端会再次渲染，所以要在客户端的生命周期如果有数据请求，必须要做处理阻止掉</strong>，可以在服务端渲染的时候添加<code>window.__INITIAL_STATE__</code>赋值给客户端的store；</p>
</blockquote>
<blockquote>
<p>3.服务端import、react等语法报错的解决方法<br>可以在服务启动前添加<code>babel-register</code>兼容；<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">require(&apos;babel-register&apos;)(&#123;</span><br><span class="line">  &quot;presets&quot;: [</span><br><span class="line">    &quot;env&quot;,</span><br><span class="line">    &quot;stage-0&quot;,</span><br><span class="line">    &quot;react&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>4.对于样式的处理<br>解决方案1: 可以在服务端渲染的时候忽略掉css不渲染css，如果项目是使用的css可以加载客户端打包的css渲染，如果是使用的预编译方式的话，可以采用第2种方式；<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function ignore() &#123;</span><br><span class="line">  var extensions = [&apos;.css&apos;, &apos;.less&apos;]; //里面定义不需要加载的文件类型</span><br><span class="line">  for (let i = 0, len = extensions.length; i &lt; len; i++) &#123;</span><br><span class="line">    require.extensions[extensions[i]] = function () &#123;</span><br><span class="line">      return false;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>解决方法2：如果你的项目是使用了预编译方式的话可以使用<a href="https://github.com/css-modules/css-modules-require-hook" target="_blank" rel="noopener">css-modules-require-hook</a>来处理css，可以解决掉报错的问题，但是在这里需要注意的话，如果你的项目是使用了<code>roadhog</code>配置的webpack而且开启了cooModeles，服务端编译的样式名称会和客户端的样式名称对应不上，导致服务端渲染的错乱的问题，网上有人推荐使用<a href="https://github.com/catamphetamine/webpack-isomorphic-tools" target="_blank" rel="noopener">webpack-isomorphic-tool</a>解决方案(个人测试没处理成功),有兴趣可以尝试下；<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">require(&apos;css-modules-require-hook&apos;)(&#123;</span><br><span class="line">  extensions: &apos;.less&apos;,</span><br><span class="line">  camelCase: true,</span><br><span class="line">  rootDir: __dirname,</span><br><span class="line">  processorOpts: &#123; parser: require(&apos;postcss-less&apos;).parse &#125;,</span><br><span class="line">  // generateScopedName: &apos;[local]___[hash:base64:5]&apos;</span><br><span class="line">  generateScopedName: &apos;[local]&apos;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>解决方案3：对应方案2无法对应样式名称的问题，我的处理方式是不使用roadhog，自己配置webpack然后搭配<code>css-modules-require-hook</code>来处理css，达到服务端和客户端css样式名称一致的问题；<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  test: /\.less$/,</span><br><span class="line">  exclude: /node_modules/,</span><br><span class="line">  use: [</span><br><span class="line">    &#123;</span><br><span class="line">      loader: MiniCssExtractPlugin.loader</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      loader: &apos;css-loader&apos;,</span><br><span class="line">      options: &#123;</span><br><span class="line">        modules: true,</span><br><span class="line">        localIdentName: &quot;[name]_[local]__[hash:base64:5]&quot;, // 需要注意名称要一致</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>##总结<br>花了一些时间终于处理关于dva同构的坑，最初卡住在如何在服务端实例化dva的router上，作者给出的案例中使用的match匹配路由的方式在react-router4.0版本行不通，应该要使用最新的<code>StaticRouter</code>去处理；还有就是关于css方面的处理，因为roadhog的话没有开放关于<code>generateScopedName</code>的配置，如果一定要渲染css的话需要自己配置了webpack；</p>
<p>##参考阅读<br><a href="https://github.com/sorrycc/dva-boilerplate-isomorphic" target="_blank" rel="noopener">dva-boilerplate-isomorphic</a><br><a href="https://github.com/alexayan/dva-example-user-dashboard-ssr" target="_blank" rel="noopener">dva-example-user-dashboard-ssr</a><br><a href="https://github.com/git-lt/isomorphism-koa2-react-antd" target="_blank" rel="noopener">isomorphism-koa2-react-antd</a></p>

                    </p>

                    <nav class="pagination" role="pagination">
    
    <span class="page-number"></span>
    
</nav>

                    
                </div>
            </div>
        </div>
    </div>
</div>

<footer>
    <p>
        &copy;&nbsp;2018&nbsp;<a target="_blank"
                                                               href="">橡树</a>
    </p>

    
    <p>Theme&nbsp;<a target="_blank"
                     href="https://github.com/SumiMakito/hexo-theme-journal">Journal.</a>&nbsp;by&nbsp;<a
                target="_blank" href="https://www.keep.moe">Makito</a>
    </p>
    

    <p>
        Proudly published with&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>
    </p>
</footer>

</div>
</div>
</div>
<script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="/js/popper.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src=" /js/vue.min.js"></script>
<script src=" /js/journal.js"></script>
<script>
    loadCSS("//fonts.googleapis.com/css?family=Source+Sans+Pro:400|Montserrat|Anonymous+Pro:400|Material+Icons");
</script>


<script>
    $(document).ready(function () {
        $("#global-loading-indicator").fadeOut(600);
    });
</script>

</body>
</html>
